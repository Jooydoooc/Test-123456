<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Past Perfect & Past Perfect Continuous Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-gradient: linear-gradient(135deg, #1e3c72, #2a5298);
      --card-bg: #ffffff;
      --accent: #4f46e5;
      --accent-soft: #eef2ff;
      --danger: #dc2626;
      --success: #16a34a;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border-soft: #e5e7eb;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-gradient);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      color: var(--text-main);
    }

    .wrapper {
      width: 100%;
      max-width: 960px;
      padding: 16px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card {
      width: 100%;
      background: var(--card-bg);
      border-radius: 18px;
      padding: 20px 18px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.25);
    }

    @media (min-width: 640px) {
      .card {
        padding: 28px 32px;
      }
    }

    h1 {
      margin: 0;
      font-size: 1.4rem;
      text-align: center;
    }

    h2 {
      margin: 4px 0 16px;
      font-size: 1rem;
      text-align: center;
      color: var(--text-muted);
      font-weight: 500;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      font-size: 0.75rem;
      font-weight: 600;
      margin: 0 auto 12px;
    }

    .badge span {
      font-size: 1rem;
    }

    .section-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .info-box {
      background: #f3f4f6;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .info-box ul {
      margin: 6px 0 0;
      padding-left: 18px;
    }

    .info-box li {
      margin-bottom: 2px;
    }

    .field-group {
      margin-bottom: 14px;
    }

    label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    input[type="text"] {
      width: 100%;
      padding: 10px 11px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.16s, box-shadow 0.16s;
    }

    input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.2);
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 11px 20px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      background: var(--accent);
      color: white;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform 0.1s, box-shadow 0.1s, background 0.16s;
    }

    button:hover {
      background: #4338ca;
      box-shadow: 0 10px 22px rgba(79, 70, 229, 0.35);
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
      box-shadow: none;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .btn-full {
      width: 100%;
      justify-content: center;
    }

    .subtext {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .question {
      margin-bottom: 14px;
      padding: 10px 10px 12px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
    }

    .question p {
      margin: 0 0 6px 0;
      font-size: 0.9rem;
    }

    #result {
      margin-top: 16px;
      padding: 12px 12px 10px;
      border-radius: 12px;
      background: #ecfdf3;
      border: 1px solid #bbf7d0;
      font-size: 0.88rem;
      display: none;
    }

    #result.error {
      background: #fef2f2;
      border-color: #fecaca;
    }

    .result-score {
      font-weight: 700;
      margin-bottom: 4px;
    }

    .result-meta {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .result-list {
      max-height: 260px;
      overflow-y: auto;
      border-top: 1px solid #e5e7eb;
      padding-top: 8px;
      margin-top: 4px;
    }

    .result-item {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 8px;
      font-size: 0.8rem;
      border-bottom: 1px dashed #e5e7eb;
      padding: 4px 0;
    }

    .result-item:last-child {
      border-bottom: none;
    }

    .result-item .left {
      flex: 1;
    }

    .chip {
      font-size: 0.7rem;
      padding: 2px 7px;
      border-radius: 999px;
      font-weight: 600;
      white-space: nowrap;
    }

    .chip.ok {
      background: #dcfce7;
      color: #166534;
    }

    .chip.bad {
      background: #fee2e2;
      color: #b91c1c;
    }

    .feedback {
      margin-top: 3px;
      font-size: 0.75rem;
      color: #4b5563;
    }

    .feedback.good {
      color: #166534;
    }

    .feedback.bad {
      color: #b91c1c;
    }

    #test-screen {
      display: none;
    }

    #overlay-cheat {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.86);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    #overlay-cheat-inner {
      max-width: 360px;
      width: 90%;
      background: #0f172a;
      color: #f9fafb;
      border-radius: 18px;
      padding: 20px 18px;
      text-align: center;
    }

    #overlay-cheat-inner h3 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 1.1rem;
    }

    #overlay-cheat-inner p {
      margin: 4px 0;
      font-size: 0.85rem;
      color: #e5e7eb;
    }

    #overlay-cheat-inner small {
      display: block;
      margin-top: 8px;
      font-size: 0.75rem;
      color: #9ca3af;
    }
  </style>
</head>
<body>
  <div id="overlay-cheat">
    <div id="overlay-cheat-inner">
      <h3>Test Stopped</h3>
      <p>You left the test screen or switched apps.</p>
      <p>This attempt is no longer valid.</p>
      <small>Please contact your teacher for a new attempt.</small>
    </div>
  </div>

  <div class="wrapper">
    <div class="card">
      <div class="badge">
        <span>üß™</span>
        Grammar Test ¬∑ B1‚ÄìB2
      </div>
      <h1>Past Perfect & Past Perfect Continuous</h1>
      <h2>Mixed Test ¬∑ 30 Questions</h2>

      <!-- START SCREEN -->
      <section id="start-screen">
        <p class="section-title">Before you start</p>
        <div class="info-box">
          <p><strong>Rules:</strong></p>
          <ul>
            <li>Enter your <strong>full name</strong> and <strong>group name</strong>.</li>
            <li>Do <strong>not</strong> leave the test or switch to other apps.</li>
            <li>Answers are checked with tolerance: capital letters, extra spaces and small spelling mistakes are accepted.</li>
          </ul>
        </div>

        <div class="field-group">
          <label for="student-name-input">Full name</label>
          <input type="text" id="student-name-input" placeholder="e.g. Doniyor Eshmurodov" />
        </div>

        <div class="field-group">
          <label for="group-name-input">Group name</label>
          <input type="text" id="group-name-input" placeholder="e.g. Beginner 9:30 Odd" />
        </div>

        <button id="start-btn" class="btn-full">
          Start Test
        </button>
        <p class="subtext">
          Once you start, do not close the browser or switch to another app.
        </p>
      </section>

      <!-- TEST SCREEN -->
      <section id="test-screen">
        <div class="info-box">
          <p><strong>Instructions:</strong></p>
          <ul>
            <li>Write the <strong>missing verb phrase</strong> in each sentence (e.g. <em>had already cooked</em>, <em>had been studying</em>).</li>
            <li>Capital letters and extra spaces <strong>do not matter</strong>.</li>
            <li>Small spelling mistakes are <strong>accepted</strong>.</li>
            <li>You can <strong>submit even if some answers are empty</strong> ‚Äì empty ones will be marked incorrect.</li>
          </ul>
        </div>

        <form id="test-form">
          <!-- hidden name/group -->
          <input type="hidden" id="student-name-hidden" name="studentName" />
          <input type="hidden" id="group-name-hidden" name="groupName" />

          <!-- QUESTIONS (no 'required') -->
          <!-- (same 30 inputs as before) -->
          <!-- I‚Äôll keep them exactly as in the previous version you used -->
          <!-- ... (for brevity in this message, assume all 30 q1‚Äìq30 blocks here exactly as before) -->

          <!-- PLEASE reuse the question blocks from the previous version you already pasted.
               They are unchanged: only 'required' was removed, which you already have. -->

          <button type="submit" class="btn-full" id="submit-btn">
            Submit Test
          </button>
        </form>

        <div id="result"></div>
      </section>
    </div>
  </div>

  <script>
    const startScreen = document.getElementById("start-screen");
    const testScreen = document.getElementById("test-screen");
    const startBtn = document.getElementById("start-btn");
    const nameInput = document.getElementById("student-name-input");
    const groupInput = document.getElementById("group-name-input");
    const nameHidden = document.getElementById("student-name-hidden");
    const groupHidden = document.getElementById("group-name-hidden");
    const overlayCheat = document.getElementById("overlay-cheat");
    const testForm = document.getElementById("test-form");
    const resultBox = document.getElementById("result");
    const submitBtn = document.getElementById("submit-btn");

    let testStarted = false;
    let examInvalid = false;

    // Feedback per question (same as before)
    const feedbackMap = { /* ... same map as previous message ... */ };

    startBtn.addEventListener("click", () => {
      const name = nameInput.value.trim();
      const group = groupInput.value.trim();

      if (!name || !group) {
        alert("Please enter your full name and group name.");
        return;
      }

      nameHidden.value = name;
      groupHidden.value = group;

      startScreen.style.display = "none";
      testScreen.style.display = "block";
      window.scrollTo(0, 0);
      testStarted = true;
    });

    // Anti-switch
    document.addEventListener("visibilitychange", () => {
      if (testStarted && !examInvalid && document.hidden) {
        examInvalid = true;
        overlayCheat.style.display = "flex";

        const inputs = testForm.querySelectorAll("input, button");
        inputs.forEach((el) => {
          el.disabled = true;
        });
      }
    });

    testForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (examInvalid) {
        alert("This attempt is no longer valid because you left the test screen.");
        return;
      }

      const formData = new FormData(testForm);
      const name = formData.get("studentName") || "";
      const group = formData.get("groupName") || "";
      const answers = {};

      for (let i = 1; i <= 30; i++) {
        answers["q" + i] = formData.get("q" + i) || "";
      }

      const emptyCount = Object.values(answers).filter((v) => !v.trim()).length;
      if (emptyCount > 0) {
        const confirmSubmit = confirm(
          `You have ${emptyCount} empty answer(s). They will be marked incorrect.\n\nDo you still want to submit?`
        );
        if (!confirmSubmit) return;
      }

      resultBox.style.display = "none";
      resultBox.classList.remove("error");
      resultBox.innerHTML = "";
      submitBtn.disabled = true;

      try {
        const res = await fetch("/api/submit", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ name, group, answers })
        });

        const data = await res.json();
        submitBtn.disabled = false;

        if (!data.success) {
          resultBox.classList.add("error");
          resultBox.textContent =
            "Something went wrong: " + (data.message || "Unknown error");
        } else {
          const score = data.score;
          const total = data.total;
          const incorrect = total - score;
          const percent = Math.round((score / total) * 100);
          const results = data.results || [];

          let html = "";
          html += `<div class="result-score">Your score: ${score} / ${total} (${percent}%)</div>`;
          html += `<div class="result-meta">Correct: <strong>${score}</strong> ¬∑ Incorrect: <strong>${incorrect}</strong></div>`;
          html += `<div class="result-meta">Name: <strong>${name}</strong> ¬∑ Group: <strong>${group}</strong></div>`;
          html += `<div class="result-meta">Your result has been sent to your teacher via Telegram.</div>`;

          html += `<div class="result-list">`;
          results.forEach((r) => {
            const chipClass = r.correct ? "ok" : "bad";
            const chipText = r.correct ? "Correct" : "Incorrect";
            const studentAns = r.studentAnswer || "";
            const keyAns = (r.correctAnswers || []).join(" / ");
            const fbBase = feedbackMap[r.question] || "";
            const fbClass = r.correct ? "good" : "bad";
            const fbText = r.correct
              ? "Good! " + fbBase
              : "Review this: " + fbBase;

            html += `
              <div class="result-item">
                <div class="left">
                  <div><strong>Q${r.question}</strong></div>
                  <div>‚úèÔ∏è Your answer: "${studentAns || "-"}"</div>
                  <div>‚úÖ Key: ${keyAns}</div>
                  <div class="feedback ${fbClass}">${fbText}</div>
                </div>
                <div>
                  <span class="chip ${chipClass}">${chipText}</span>
                </div>
              </div>
            `;
          });
          html += `</div>`;

          resultBox.innerHTML = html;
        }
      } catch (err) {
        console.error(err);
        submitBtn.disabled = false;
        resultBox.classList.add("error");
        resultBox.textContent = "Network error. Please try again.";
      }

      resultBox.style.display = "block";
      resultBox.scrollIntoView({ behavior: "smooth" });
    });
  </script>
</body>
</html>
